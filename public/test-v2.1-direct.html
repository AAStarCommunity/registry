<!DOCTYPE html>
<html>
<head>
  <title>Direct Test Registry v2.1</title>
  <script type="module">
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm';

    window.testRegistry = async function() {
      const output = document.getElementById('output');
      output.innerHTML = '<p><strong>Testing Registry v2.1...</strong></p>';

      const rpcUrl = "https://rpc.sepolia.org";
      const registryAddress = "0x3F7E822C7FD54dBF8df29C6EC48E08Ce8AcEBeb3";

      try {
        const provider = new ethers.JsonRpcProvider(rpcUrl);

        // Test 1: Wrong ABI (with 'external')
        output.innerHTML += '<h3>Test 1: ABI with "external" keyword</h3>';
        try {
          const wrongABI = ["function getCommunityCount() external view returns (uint256)"];
          const contract1 = new ethers.Contract(registryAddress, wrongABI, provider);
          const count1 = await contract1.getCommunityCount();
          output.innerHTML += '<p style="color: green;">Success: ' + count1.toString() + '</p>';
        } catch (err) {
          output.innerHTML += '<p style="color: red;">Failed: ' + err.message + '</p>';
        }

        // Test 2: Correct ABI (without 'external')
        output.innerHTML += '<h3>Test 2: ABI without "external" keyword</h3>';
        try {
          const correctABI = ["function getCommunityCount() view returns (uint256)"];
          const contract2 = new ethers.Contract(registryAddress, correctABI, provider);
          const count2 = await contract2.getCommunityCount();
          output.innerHTML += '<p style="color: green;">Success: ' + count2.toString() + ' communities</p>';
        } catch (err) {
          output.innerHTML += '<p style="color: red;">Failed: ' + err.message + '</p>';
        }

        // Test 3: Even simpler ABI (no view)
        output.innerHTML += '<h3>Test 3: Minimal ABI (no view keyword)</h3>';
        try {
          const minimalABI = ["function getCommunityCount() returns (uint256)"];
          const contract3 = new ethers.Contract(registryAddress, minimalABI, provider);
          const count3 = await contract3.getCommunityCount();
          output.innerHTML += '<p style="color: green;">Success: ' + count3.toString() + ' communities</p>';
        } catch (err) {
          output.innerHTML += '<p style="color: red;">Failed: ' + err.message + '</p>';
        }

      } catch (err) {
        output.innerHTML += '<p style="color: red;">Fatal: ' + err.message + '</p>';
      }
    };

    window.addEventListener('load', () => window.testRegistry());
  </script>
</head>
<body>
  <h1>Registry v2.1 Direct ABI Test</h1>
  <p>Using ethers.js v6.15.0 from CDN</p>
  <p>Contract: 0x3F7E822C7FD54dBF8df29C6EC48E08Ce8AcEBeb3</p>
  <button onclick="window.testRegistry()">Run Test Again</button>
  <hr>
  <div id="output"></div>
</body>
</html>
